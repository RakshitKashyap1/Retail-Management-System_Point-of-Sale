{% extends 'base.html' %}
{% load currency_tags %}

{% block title %}Sales History - RMS POS{% endblock %}

{% block content %}
<style>
    .receipt-id {
        font-family: monospace;
        color: #4facfe;
        font-weight: 600;
    }

    .amount-display {
        font-weight: 700;
        color: #a8e063;
        font-size: 1.1rem;
    }

    .cashier-avatar {
        width: 24px;
        height: 24px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
    }

    .view-filters {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    /* Override input styles for date inputs to look better */
    input[type="date"],
    input[type="month"] {
        color-scheme: dark;
        /* Helps with dark mode calendar */
    }

    .print-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .print-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .print-btn svg {
        width: 18px;
        height: 18px;
    }

    .print-header {
        display: none;
    }

    /* Print Styles */
    @media print {

        /* Hide navigation, filters, and non-essential elements */
        .sidebar,
        .topbar,
        .view-filters,
        .page-header,
        .print-btn,
        .cashier-avatar,
        form,
        .btn,
        nav {
            display: none !important;
        }

        /* Reset page layout */
        body {
            background: #fff !important;
            color: #000 !important;
            font-family: 'Arial', sans-serif;
            padding: 0;
            margin: 0;
        }

        .main-content {
            margin-left: 0 !important;
            padding: 0 !important;
            background: #fff !important;
        }

        .card {
            background: #fff !important;
            border: 1px solid #ddd !important;
            box-shadow: none !important;
            margin: 0 !important;
            border-radius: 0 !important;
        }

        .card-header {
            background: #f5f5f5 !important;
            border-bottom: 2px solid #333 !important;
            padding: 10px 15px !important;
        }

        .card-header h3 {
            color: #000 !important;
            font-size: 14pt !important;
        }

        .card-body {
            padding: 0 !important;
            background: #fff !important;
        }

        /* Print Header */
        .print-header {
            display: block !important;
            text-align: center;
            padding: 20px;
            border-bottom: 3px solid #333;
            margin-bottom: 20px;
        }

        .print-header h1 {
            font-size: 24pt;
            margin: 0 0 5px 0;
            color: #000;
            font-weight: 700;
        }

        .print-header .store-name {
            font-size: 18pt;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .print-header .report-title {
            font-size: 14pt;
            font-weight: 600;
            color: #555;
            margin: 10px 0;
        }

        .print-header .report-date {
            font-size: 12pt;
            color: #666;
        }

        .print-header .print-timestamp {
            font-size: 9pt;
            color: #888;
            margin-top: 5px;
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10pt;
        }

        thead {
            display: table-header-group;
        }

        thead tr {
            background: #f0f0f0 !important;
        }

        th {
            background: #e0e0e0 !important;
            color: #000 !important;
            font-weight: 700;
            padding: 10px 8px !important;
            border: 1px solid #ccc;
            text-align: left;
        }

        td {
            padding: 8px !important;
            border: 1px solid #ddd;
            color: #000 !important;
            vertical-align: top;
        }

        tbody tr:nth-child(even) {
            background: #f9f9f9 !important;
        }

        .receipt-id {
            color: #000 !important;
            font-family: 'Courier New', monospace;
        }

        .amount-display {
            color: #000 !important;
            font-weight: 700;
        }

        /* Summary Section */
        .print-summary {
            display: block !important;
            margin-top: 20px;
            padding: 15px;
            border: 2px solid #333;
            background: #f5f5f5 !important;
        }

        .print-summary .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 12pt;
        }

        .print-summary .summary-total {
            font-size: 16pt;
            font-weight: 700;
            border-top: 2px solid #333;
            padding-top: 10px;
            margin-top: 10px;
        }

        /* Page Break */
        .page-break {
            page-break-before: always;
        }

        @page {
            margin: 1cm;
            size: A4;
        }

        /* Hide stat card on print, show summary instead */
        .stat-card {
            display: none !important;
        }

        .mb-4 {
            margin-bottom: 0 !important;
        }

        /* Hide non-print summary */
        .no-print {
            display: none !important;
        }
    }

    .print-summary {
        display: none;
    }
</style>

<div class="page-header">
    <div>
        <h1 class="page-title">Sales History</h1>
        <p class="page-subtitle">View all past receipts and transactions</p>
    </div>
</div>

<div class="view-filters">
    <a href="?view=all" class="btn {% if view_type == 'all' %}btn-primary{% else %}btn-secondary{% endif %}"
        style="display:inline-flex; align-items:center;">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            style="margin-right:0.5rem;">
            <line x1="8" y1="6" x2="21" y2="6"></line>
            <line x1="8" y1="12" x2="21" y2="12"></line>
            <line x1="8" y1="18" x2="21" y2="18"></line>
            <line x1="3" y1="6" x2="3.01" y2="6"></line>
            <line x1="3" y1="12" x2="3.01" y2="12"></line>
            <line x1="3" y1="18" x2="3.01" y2="18"></line>
        </svg> All History
    </a>
    <a href="?view=daily" class="btn {% if view_type == 'daily' %}btn-primary{% else %}btn-secondary{% endif %}"
        style="display:inline-flex; align-items:center;">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            style="margin-right:0.5rem;">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
            <path d="M8 14h.01" />
            <path d="M12 14h.01" />
            <path d="M16 14h.01" />
            <path d="M8 18h.01" />
            <path d="M12 18h.01" />
            <path d="M16 18h.01" />
        </svg> Day Wise Sales
    </a>
    <a href="?view=monthly" class="btn {% if view_type == 'monthly' %}btn-primary{% else %}btn-secondary{% endif %}"
        style="display:inline-flex; align-items:center;">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            style="margin-right:0.5rem;">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg> Month Wise Sales
    </a>
    <a href="{% url 'export_sales_data' %}?{{ request.GET.urlencode }}" class="btn btn-secondary"
        style="display:inline-flex; align-items:center; background: #28a745; color: white; border: none;">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            style="margin-right:0.5rem;">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
        </svg> Export to Excel
    </a>
</div>

{% if view_type == 'daily' %}
<!-- Print Header for Daily Report -->
<div class="print-header">
    <div class="store-name">RMS Point of Sale</div>
    <h1>Daily Sales Report</h1>
    <div class="report-date">Date: {{ selected_date|default:"All Dates" }}</div>
    <div class="print-timestamp">Generated on: <span id="daily-print-time"></span></div>
</div>

<!-- Daily Sales Section -->
<div class="card mb-4" style="margin-bottom: 2rem; border-color: rgba(168, 224, 99, 0.3);">
    <div class="card-body">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <form method="GET" style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                <input type="hidden" name="view" value="daily">
                <div>
                    <label style="margin-bottom: 0.5rem;">Select Date</label>
                    <input type="date" name="date" value="{{ selected_date|default:'' }}" onchange="this.form.submit()"
                        class="form-control" style="max-width: 250px;">
                </div>
            </form>
            <button class="print-btn" onclick="printDailyReport()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="6 9 6 2 18 2 18 9"></polyline>
                    <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                    <rect x="6" y="14" width="12" height="8"></rect>
                </svg>
                Print Daily Report
            </button>
            <div class="stat-card"
                style="padding: 1rem 2rem; min-width: 250px; text-align: right; background: rgba(168, 224, 99, 0.1);">
                <div
                    style="font-size: 0.9rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px;">
                    Total Daily Sales</div>
                <div class="amount-display" style="font-size: 2rem;">{{ total_sales|rupee_paise }}</div>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary);">Daily Sales Report</h3>
    </div>
    <div class="card-body" style="padding: 0;">
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Receipt #</th>
                        <th>Time</th>
                        <th>Cashier</th>
                        <th>Items</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in sales %}
                    <tr>
                        <td><span class="receipt-id">#{{ sale.receipt_number|default:sale.id }}</span></td>
                        <td style="color: #b0b3c1;">{{ sale.created_at|date:"H:i" }}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div class="cashier-avatar">{{ sale.cashier.username|slice:":1"|upper }}</div>
                                {{ sale.cashier.username }}
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                {% for item in sale.items.all %}
                                <div style="font-size: 0.9rem;">
                                    <span style="color: var(--text-primary);">{{ item.product.name }}</span>
                                    <span style="color: var(--text-muted);">x{{ item.quantity }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </td>
                        <td class="amount-display">{{ sale.total_amount|rupee_paise }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 3rem; color: #6b6e7d;">
                            No sales found for this date.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Print Summary for Daily -->
<div class="print-summary">
    <div class="summary-row">
        <span>Total Transactions:</span>
        <span>{{ sales|length }}</span>
    </div>
    <div class="summary-row summary-total">
        <span>Total Sales:</span>
        <span>{{ total_sales|rupee_paise }}</span>
    </div>
</div>

{% elif view_type == 'monthly' %}
<!-- Print Header for Monthly Report -->
<div class="print-header">
    <div class="store-name">RMS Point of Sale</div>
    <h1>Monthly Sales Report</h1>
    <div class="report-date">Month: {{ selected_month|default:"All Months" }}</div>
    <div class="print-timestamp">Generated on: <span id="monthly-print-time"></span></div>
</div>

<!-- Monthly Sales Section -->
<div class="card mb-4" style="margin-bottom: 2rem; border-color: rgba(79, 172, 254, 0.3);">
    <div class="card-body">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <form method="GET" style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                <input type="hidden" name="view" value="monthly">
                <div>
                    <label style="margin-bottom: 0.5rem;">Select Month</label>
                    <input type="month" name="month" value="{{ selected_month|default:'' }}"
                        onchange="this.form.submit()" class="form-control" style="max-width: 250px;">
                </div>
            </form>
            <button class="print-btn" onclick="printMonthlyReport()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="6 9 6 2 18 2 18 9"></polyline>
                    <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                    <rect x="6" y="14" width="12" height="8"></rect>
                </svg>
                Print Monthly Report
            </button>
            <div class="stat-card blue"
                style="padding: 1rem 2rem; min-width: 250px; text-align: right; background: rgba(79, 172, 254, 0.1);">
                <div
                    style="font-size: 0.9rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px;">
                    Total Monthly Sales</div>
                <div class="amount-display" style="font-size: 2rem; color: #4facfe;">{{ total_sales|rupee_paise }}</div>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary);">Monthly Sales Report</h3>
    </div>
    <div class="card-body" style="padding: 0;">
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Receipt #</th>
                        <th>Date</th>
                        <th>Cashier</th>
                        <th>Items Count</th>
                        <th>Total Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in sales %}
                    <tr>
                        <td><span class="receipt-id">#{{ sale.receipt_number|default:sale.id }}</span></td>
                        <td style="color: #b0b3c1;">{{ sale.created_at|date:"M d, H:i" }}</td>
                        <td>{{ sale.cashier.username }}</td>
                        <td>{{ sale.items.count }} items</td>
                        <td class="amount-display">{{ sale.total_amount|rupee_paise }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 3rem; color: #6b6e7d;">
                            No sales found for this month.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Print Summary for Monthly -->
<div class="print-summary">
    <div class="summary-row">
        <span>Total Transactions:</span>
        <span>{{ sales|length }}</span>
    </div>
    <div class="summary-row summary-total">
        <span>Total Sales:</span>
        <span>{{ total_sales|rupee_paise }}</span>
    </div>
</div>

{% else %}
<!-- Default All History Section -->
<div class="card">
    <div class="card-body" style="padding: 0;">
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Receipt #</th>
                        <th>Date & Time</th>
                        <th>Cashier</th>
                        <th>Items</th>
                        <th>Total Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in sales %}
                    <tr>
                        <td>
                            <span class="receipt-id">#{{ sale.receipt_number|default:sale.id }}</span>
                        </td>
                        <td style="color: #b0b3c1;">
                            {{ sale.created_at|date:"M d, Y H:i" }}
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div class="cashier-avatar">
                                    {{ sale.cashier.username|slice:":1"|upper }}
                                </div>
                                {{ sale.cashier.username }}
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                {% for item in sale.items.all %}
                                <div style="font-size: 0.9rem;">
                                    <span style="color: var(--text-primary);">{{ item.product.name }}</span>
                                    <span style="color: var(--text-muted);">x{{ item.quantity }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                <span class="amount-display">{{ sale.total_amount|rupee_paise }}</span>
                                {% if sale.discount_amount > 0 %}
                                <span style="font-size: 0.8rem; color: #ef4444;">Saved {{
                                    sale.discount_amount|rupee_paise }}</span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 3rem; color: #6b6e7d;">
                            No sales found yet.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<script>
    // Print functions
    function printDailyReport() {
        // Set the print timestamp
        const printTimeEl = document.getElementById('daily-print-time');
        if (printTimeEl) {
            printTimeEl.textContent = new Date().toLocaleString('en-IN', {
                dateStyle: 'full',
                timeStyle: 'short'
            });
        }
        window.print();
    }

    function printMonthlyReport() {
        // Set the print timestamp
        const printTimeEl = document.getElementById('monthly-print-time');
        if (printTimeEl) {
            printTimeEl.textContent = new Date().toLocaleString('en-IN', {
                dateStyle: 'full',
                timeStyle: 'short'
            });
        }
        window.print();
    }
</script>
{% endblock %}